<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音声変換＆3時間分割ツール + AIアシスタント</title>
    
    <!-- COI Script: GitHub Pages対応版 -->
    <script>
        if (typeof window !== 'undefined' && window.isSecureContext) {
            if (!window.crossOriginIsolated) {
                console.log("SharedArrayBuffer is disabled. Attempting to enable via Service Worker...");
                
                // 1. まず推奨される sw.js (別ファイル) を探しに行く
                navigator.serviceWorker.register("./sw.js")
                    .then((reg) => {
                        console.log("sw.js registered. Reloading...");
                        // 登録成功したらリロードしてヘッダーを適用させる
                        // 無限ループ防止のため、失敗が続くようなら停止するロジックを入れるのが理想だが
                        // ここではシンプルにリロードする
                        setTimeout(() => window.location.reload(), 500);
                    })
                    .catch((err) => {
                        console.log("sw.js not found or failed. Trying inline fallback...", err);
                        
                        // 2. sw.jsがない場合、インラインのフォールバックを試みる (ローカル環境用)
                         const workerCode = `
                            self.addEventListener("install", () => self.skipWaiting());
                            self.addEventListener("activate", (event) => event.waitUntil(self.clients.claim()));
                            self.addEventListener("fetch", (event) => {
                                if (event.request.cache === "only-if-cached" && event.request.mode !== "same-origin") return;
                                event.respondWith(
                                    fetch(event.request)
                                        .then((response) => {
                                            if (response.status === 0) return response;
                                            const newHeaders = new Headers(response.headers);
                                            newHeaders.set("Cross-Origin-Embedder-Policy", "require-corp");
                                            newHeaders.set("Cross-Origin-Opener-Policy", "same-origin");
                                            return new Response(response.body, {
                                                status: response.status,
                                                statusText: response.statusText,
                                                headers: newHeaders,
                                            });
                                        })
                                        .catch((e) => console.error(e))
                                );
                            });
                        `;
                        const blob = new Blob([workerCode], { type: 'application/javascript' });
                        const url = URL.createObjectURL(blob);
                        navigator.serviceWorker.register(url)
                            .then((reg) => {
                                console.log("Inline SW registered. Reloading...");
                                setTimeout(() => window.location.reload(), 500);
                            })
                            .catch((e) => console.error("Inline SW failed:", e));
                    });
            }
        }
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ffmpeg.wasm (Version 0.10.1 for better compat with script tags) -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.10.1/dist/ffmpeg.min.js"></script>
    <!-- Markdown parser for AI response -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; }
        
        /* Custom scrollbar for log area */
        .log-area::-webkit-scrollbar {
            width: 8px;
        }
        .log-area::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .log-area::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .log-area::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* AI Result Styling */
        .prose h3 { font-size: 1.1em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: #1e40af; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .prose li { margin-bottom: 0.25em; }
        .prose strong { color: #1f2937; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center py-10 px-4">

    <div class="max-w-2xl w-full bg-white rounded-xl shadow-lg p-6 md:p-8">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2 text-center">音声変換＆分割ツール</h1>
        <p class="text-gray-500 text-center mb-6 text-sm">
            ファイルをMP3に変換し、3時間ごとに自動分割します。<br>
            サーバーへのアップロードは行われません。すべて端末内で処理されます。
        </p>

        <!-- Alert Box for SharedArrayBuffer/Cross-Origin Issues -->
        <div id="cross-origin-alert" class="hidden mb-6 bg-red-50 border-l-4 border-red-400 p-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-bold text-red-800 mb-1" id="alert-title">動作環境のエラー</h3>
                    <div class="text-sm text-red-700" id="alert-message">
                        <!-- Dynamic Message -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Uploader -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">音声ファイルを選択</label>
            <div class="flex items-center justify-center w-full">
                <label for="file-upload" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                        <svg class="w-8 h-8 mb-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/>
                        </svg>
                        <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">クリックしてアップロード</span></p>
                        <p class="text-xs text-gray-500">WAV, MP3, M4A, OGGなど (最大2GB推奨)</p>
                    </div>
                    <input id="file-upload" type="file" class="hidden" accept="audio/*,video/*" />
                </label>
            </div>
            <p id="file-name" class="mt-2 text-sm text-blue-600 font-medium h-5 text-center"></p>
        </div>

        <!-- Controls -->
        <div class="flex flex-col gap-4 mb-8">
            <div class="flex items-center justify-between bg-gray-100 p-3 rounded-lg">
                <span class="text-sm font-medium text-gray-700">分割時間:</span>
                <span class="text-sm font-bold text-gray-900">3時間 (10800秒)</span>
            </div>
            
            <button id="convert-btn" disabled class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-lg px-5 py-3 text-center disabled:opacity-50 disabled:cursor-not-allowed transition shadow-md">
                変換・分割を開始
            </button>
        </div>

        <!-- AI Assistant Section -->
        <div class="mb-8 border-t border-gray-200 pt-6">
            <div class="flex items-center gap-2 mb-3">
                <span class="text-xl">✨</span>
                <h2 class="text-lg font-bold text-gray-800">AIファイル整理アシスタント</h2>
            </div>
            <p class="text-sm text-gray-600 mb-4">
                録音内容（会議名、イベント概要など）を入力すると、Geminiが分割ファイルごとの最適なタイトルやファイル名の案を提案します。
            </p>
            
            <div class="flex flex-col sm:flex-row gap-2 mb-4">
                <input type="text" id="ai-prompt" placeholder="例: 社内プレゼン大会 2024 (全9時間)" 
                    class="flex-1 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                <button id="ai-generate-btn" class="text-white bg-gradient-to-r from-purple-500 to-pink-500 hover:bg-gradient-to-l focus:ring-4 focus:outline-none focus:ring-purple-200 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition flex items-center justify-center gap-2 whitespace-nowrap">
                    <span>✨ 案を作成</span>
                </button>
            </div>

            <!-- AI Loading -->
            <div id="ai-loading" class="hidden text-center py-4">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500 mx-auto mb-2"></div>
                <p class="text-sm text-purple-600 animate-pulse">Geminiが考え中...</p>
            </div>

            <!-- AI Output -->
            <div id="ai-result" class="hidden bg-purple-50 border border-purple-100 rounded-lg p-4 prose prose-sm max-w-none text-gray-700">
                <!-- Content will be injected here -->
            </div>
        </div>

        <!-- Progress -->
        <div id="progress-container" class="hidden mb-6">
            <div class="flex justify-between mb-1">
                <span id="progress-text" class="text-sm font-medium text-blue-700">準備中...</span>
                <span id="progress-percent" class="text-sm font-medium text-blue-700">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <p class="text-xs text-gray-500 mt-2">※ファイルサイズが大きい場合、処理に数分〜数十分かかることがあります。</p>
        </div>

        <!-- Results -->
        <div id="results-area" class="hidden mb-6">
            <h3 class="text-lg font-bold text-gray-800 mb-3 border-b pb-2">ダウンロード</h3>
            <div id="download-list" class="space-y-2">
                <!-- Links will be injected here -->
            </div>
        </div>

        <!-- Logs -->
        <div class="mt-4">
            <button id="toggle-log" class="text-xs text-gray-500 underline mb-2 hover:text-gray-700">ログを表示/非表示</button>
            <div id="log-area" class="hidden log-area w-full bg-gray-900 text-green-400 font-mono text-xs p-4 rounded-lg h-40 overflow-y-auto whitespace-pre-wrap"></div>
        </div>

    </div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        const apiKey = ""; // System provides this at runtime
        
        // Configuration
        const SEGMENT_TIME = 10800; // 3 hours in seconds
        
        // Elements
        const fileInput = document.getElementById('file-upload');
        const fileNameDisplay = document.getElementById('file-name');
        const convertBtn = document.getElementById('convert-btn');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');
        const progressText = document.getElementById('progress-text');
        const logArea = document.getElementById('log-area');
        const resultsArea = document.getElementById('results-area');
        const downloadList = document.getElementById('download-list');
        const toggleLogBtn = document.getElementById('toggle-log');
        const alertBox = document.getElementById('cross-origin-alert');

        // AI Elements
        const aiPromptInput = document.getElementById('ai-prompt');
        const aiGenerateBtn = document.getElementById('ai-generate-btn');
        const aiLoading = document.getElementById('ai-loading');
        const aiResult = document.getElementById('ai-result');

        let ffmpeg = null;
        let selectedFile = null;

        // Initialize FFmpeg
        async function initFFmpeg() {
            try {
                // SharedArrayBuffer check
                if (typeof SharedArrayBuffer === 'undefined') {
                    // Try to wait a bit in case the Service Worker is reloading the page
                    // But if it's still undefined, show alert
                    setTimeout(() => {
                        if (typeof SharedArrayBuffer === 'undefined') {
                            showError();
                        }
                    }, 1000);
                    
                    if (typeof SharedArrayBuffer === 'undefined') return; 
                }

                ffmpeg = createFFmpeg({
                    log: true,
                    corePath: 'https://unpkg.com/@ffmpeg/core@0.10.0/dist/ffmpeg-core.js',
                });

                ffmpeg.setLogger(({ type, message }) => {
                    log(`[${type}] ${message}`);
                    if (message.includes('time=')) {
                        const timeMatch = message.match(/time=(\d{2}):(\d{2}):(\d{2})\.\d{2}/);
                        if (timeMatch && selectedFile) {
                            progressText.innerText = `処理中... (${message.match(/time=\S+/)[0]})`;
                        }
                    }
                });

                await ffmpeg.load();
                log("FFmpeg loaded successfully.");
                alertBox.classList.add('hidden'); // Hide alert if load succeeds
            } catch (e) {
                log("Error loading FFmpeg: " + e.message);
                alertBox.classList.remove('hidden');
            }
        }

        function showError() {
            const alertBox = document.getElementById('cross-origin-alert');
            const alertTitle = document.getElementById('alert-title');
            const alertMessage = document.getElementById('alert-message');
            
            alertBox.classList.remove('hidden');

            if (location.protocol === 'file:') {
                alertTitle.textContent = "ファイルを直接開いていませんか？";
                alertMessage.innerHTML = `
                    <p class="mb-2">このアプリは高度な変換機能を使用するため、ファイルをダブルクリックして直接開く（file://形式）ことはできません。</p>
                    <p class="font-bold mb-1">解決策：</p>
                    <ul class="list-disc list-inside">
                        <li><strong>VS Codeをお使いの場合:</strong> 拡張機能「Live Server」で開いてください。</li>
                        <li><strong>Pythonがある場合:</strong> フォルダ内で <code>python -m http.server</code> を実行し、<code>http://localhost:8000</code> にアクセスしてください。</li>
                    </ul>
                `;
            } else {
                alertTitle.textContent = "GitHub Pagesでのエラー";
                alertMessage.innerHTML = `
                    <p class="mb-2">ブラウザのセキュリティ制限により、<code>sw.js</code> が読み込まれていません。</p>
                    <p class="font-bold mb-1">解決策：</p>
                    <p>このHTMLファイルと同じフォルダに <strong>sw.js</strong> というファイルをアップロードしてください。</p>
                    <p class="text-xs text-gray-500 mt-2">※アップロードしても消えない場合は、ブラウザのキャッシュをクリアして再読み込みしてください。</p>
                `;
            }
            log("Error: SharedArrayBuffer is not available. Please ensure sw.js is uploaded.");
        }

        function log(message) {
            const time = new Date().toLocaleTimeString();
            logArea.textContent += `[${time}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(message);
        }

        toggleLogBtn.addEventListener('click', () => {
            logArea.classList.toggle('hidden');
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                selectedFile = file;
                fileNameDisplay.textContent = `${file.name} (${(file.size / (1024 * 1024)).toFixed(2)} MB)`;
                convertBtn.disabled = false;
                convertBtn.textContent = "変換・分割を開始";
                downloadList.innerHTML = '';
                resultsArea.classList.add('hidden');
                alertBox.classList.add('hidden');
                
                // Auto-fill AI prompt if empty
                if (!aiPromptInput.value) {
                    aiPromptInput.value = file.name.split('.')[0];
                }

                if (!ffmpeg) initFFmpeg();
            }
        });

        // AI Generation Logic
        aiGenerateBtn.addEventListener('click', async () => {
            const userPrompt = aiPromptInput.value.trim();
            if (!userPrompt) {
                alert("録音内容の説明を入力してください。");
                return;
            }

            aiLoading.classList.remove('hidden');
            aiResult.classList.add('hidden');
            aiGenerateBtn.disabled = true;

            try {
                const systemPrompt = `
                    You are a helpful audio content assistant. 
                    The user has a long audio recording that is being split into 3-hour segments using an automated tool.
                    Based on the user's description of the content, suggest metadata for the split files.
                    
                    Assume the audio might be 6-12 hours long (2-4 parts).
                    
                    Output in Markdown format with:
                    1. A creative series title.
                    2. For each part (Part 1, Part 2, Part 3...), suggest:
                       - A descriptive Title (e.g. "Opening & Keynote")
                       - A clean File Name (alphanumeric, e.g. "conf_2024_part1.mp3")
                       - A short 1-line description of what typically happens in this time block based on the context (e.g. "Morning session covering X and Y").
                    
                    Keep the tone helpful and organized. Respond in Japanese.
                `;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Content Description: ${userPrompt}` }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });

                if (!response.ok) throw new Error('API request failed');

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "生成できませんでした。";

                aiResult.innerHTML = marked.parse(text);
                aiResult.classList.remove('hidden');

            } catch (error) {
                console.error(error);
                alert("AI生成中にエラーが発生しました。");
            } finally {
                aiLoading.classList.add('hidden');
                aiGenerateBtn.disabled = false;
            }
        });

        // Conversion Logic
        convertBtn.addEventListener('click', async () => {
            if (!ffmpeg || !ffmpeg.isLoaded()) {
                await initFFmpeg();
            }
            
            // Re-check buffer availability after init attempt
            if (typeof SharedArrayBuffer === 'undefined') {
                alertBox.classList.remove('hidden');
                return;
            }
            
            if (!selectedFile) return;

            convertBtn.disabled = true;
            convertBtn.classList.add('opacity-50', 'cursor-not-allowed');
            progressContainer.classList.remove('hidden');
            progressText.innerText = "ファイルを読み込み中...";
            progressBar.style.width = '10%';
            progressPercent.innerText = '10%';

            try {
                const inputName = 'input_audio' + getExtension(selectedFile.name);
                
                log("Writing file to memory...");
                ffmpeg.FS('writeFile', inputName, await fetchFile(selectedFile));
                
                progressBar.style.width = '30%';
                progressPercent.innerText = '30%';
                progressText.innerText = "変換・分割処理中...";

                log("Starting conversion...");
                
                await ffmpeg.run(
                    '-i', inputName,
                    '-f', 'segment',
                    '-segment_time', String(SEGMENT_TIME),
                    '-c:a', 'libmp3lame',
                    '-q:a', '4', 
                    'output_%03d.mp3'
                );

                progressBar.style.width = '90%';
                progressPercent.innerText = '90%';
                progressText.innerText = "出力ファイルを生成中...";

                const files = ffmpeg.FS('readdir', '/');
                const outputFiles = files.filter(f => f.startsWith('output_') && f.endsWith('.mp3'));

                if (outputFiles.length === 0) {
                    throw new Error("出力ファイルが生成されませんでした。ログを確認してください。");
                }

                downloadList.innerHTML = '';
                outputFiles.sort();

                outputFiles.forEach((file, index) => {
                    const data = ffmpeg.FS('readFile', file);
                    const blob = new Blob([data.buffer], { type: 'audio/mp3' });
                    const url = URL.createObjectURL(blob);
                    
                    const item = document.createElement('div');
                    item.className = "flex items-center justify-between bg-gray-50 p-3 rounded border border-gray-200";
                    
                    const startH = index * 3;
                    const endH = (index + 1) * 3;
                    
                    const infoDiv = document.createElement('div');
                    infoDiv.className = "flex flex-col overflow-hidden mr-2";
                    infoDiv.innerHTML = `
                        <span class="text-sm font-bold text-gray-800">パート ${index + 1}</span>
                        <span class="text-xs text-gray-500 truncate">${startH}時間〜${endH}時間</span>
                    `;

                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${selectedFile.name.split('.')[0]}_part${index + 1}.mp3`;
                    link.className = "text-white bg-green-500 hover:bg-green-600 px-3 py-2 rounded text-xs font-bold transition flex items-center shadow-sm whitespace-nowrap";
                    link.innerHTML = `
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        保存
                    `;

                    item.appendChild(infoDiv);
                    item.appendChild(link);
                    downloadList.appendChild(item);
                });

                resultsArea.classList.remove('hidden');
                
                ffmpeg.FS('unlink', inputName);
                outputFiles.forEach(f => ffmpeg.FS('unlink', f));

                progressBar.style.width = '100%';
                progressPercent.innerText = '100%';
                progressText.innerText = "完了！";
                convertBtn.textContent = "完了しました";

            } catch (error) {
                log("Error: " + error.message);
                alert("エラーが発生しました: " + error.message);
                progressText.innerText = "エラーが発生しました";
                progressText.classList.add("text-red-600");
                convertBtn.disabled = false;
            }
        });

        function getExtension(filename) {
            const parts = filename.split('.');
            return parts.length > 1 ? '.' + parts.pop() : '';
        }

        // Removed initial check here as initFFmpeg handles it now
    </script>
</body>
</html>
